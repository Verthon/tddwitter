import 'module';
/*#__PURE__*/ import.meta.url;
import { extname } from "path";
import { InternalBasePlugin } from "./base.js";
import { chalk, logger, time, timeEnd } from "@rsdoctor/utils/logger";
class InternalBundleTagPlugin extends InternalBasePlugin {
    apply(compiler) {
        time('InternalBundleTagPlugin.apply');
        try {
            var _this_options_supports;
            const supportBannerPlugin = null == (_this_options_supports = this.options.supports) ? void 0 : _this_options_supports.banner;
            compiler.hooks.compilation.tap('RsdoctorTagBannerPlugin', (compilation)=>{
                compilation.hooks.processAssets.tapPromise({
                    name: 'RsdoctorTagBannerPlugin',
                    stage: -2000
                }, async ()=>{
                    var _compiler_options_optimization;
                    if (!compilation.options.plugins.map((p)=>p && p.constructor.name).includes('BannerPlugin') && true !== supportBannerPlugin || false === supportBannerPlugin || 'rspack' in compiler) return;
                    logger.info(chalk.magenta("Rsdoctor's `supports.banner` option is enabled, this is for debugging only. Do not use it for production."));
                    const minimizers = (null == (_compiler_options_optimization = compiler.options.optimization) ? void 0 : _compiler_options_optimization.minimizer) || [];
                    const terserPlugin = minimizers.find((plugin)=>{
                        var _plugin_constructor;
                        return (null == plugin ? void 0 : null == (_plugin_constructor = plugin.constructor) ? void 0 : _plugin_constructor.name) === 'TerserPlugin';
                    });
                    const swcPlugin = minimizers.find((plugin)=>{
                        var _plugin_constructor;
                        return (null == plugin ? void 0 : null == (_plugin_constructor = plugin.constructor) ? void 0 : _plugin_constructor.name) === 'SwcJsMinimizerRspackPlugin';
                    });
                    const hasTerserPlugin = !!terserPlugin;
                    const hasSwcJsMinimizer = !!swcPlugin;
                    if (hasTerserPlugin || hasSwcJsMinimizer) {
                        var _terserPlugin_options_minimizer_options_compress, _terserPlugin_options_minimizer_options, _terserPlugin_options_minimizer, _terserPlugin_options, _swcPlugin__args__minimizerOptions_compress, _swcPlugin__args__minimizerOptions, _swcPlugin__args_, _swcPlugin__args;
                        const terserDropConsole = null == terserPlugin ? void 0 : null == (_terserPlugin_options = terserPlugin.options) ? void 0 : null == (_terserPlugin_options_minimizer = _terserPlugin_options.minimizer) ? void 0 : null == (_terserPlugin_options_minimizer_options = _terserPlugin_options_minimizer.options) ? void 0 : null == (_terserPlugin_options_minimizer_options_compress = _terserPlugin_options_minimizer_options.compress) ? void 0 : _terserPlugin_options_minimizer_options_compress.drop_console;
                        const swcDropConsole = null == swcPlugin ? void 0 : null == (_swcPlugin__args = swcPlugin._args) ? void 0 : null == (_swcPlugin__args_ = _swcPlugin__args[0]) ? void 0 : null == (_swcPlugin__args__minimizerOptions = _swcPlugin__args_.minimizerOptions) ? void 0 : null == (_swcPlugin__args__minimizerOptions_compress = _swcPlugin__args__minimizerOptions.compress) ? void 0 : _swcPlugin__args__minimizerOptions_compress.drop_console;
                        if (true === terserDropConsole || true === swcDropConsole) logger.warn(chalk.yellow('Warning: BannerPlugin detected in project. Please disable drop_console option in TerserPlugin or SwcJsMinimizerRspackPlugin to enable Rsdoctor analysis for BannerPlugin.'));
                    }
                    const chunks = compilation.chunks;
                    for (let chunk of chunks)for (const file of chunk.files){
                        if (!file || '.js' !== extname(file)) continue;
                        const { ConcatSource } = compiler.webpack.sources;
                        compilation.updateAsset(file, (old)=>{
                            const concatSource = new ConcatSource();
                            let header = "\n console.log('RSDOCTOR_START::');\n";
                            let footer = "\n console.log('RSDOCTOR_END::');\n";
                            concatSource.add(header);
                            concatSource.add(old);
                            concatSource.add(footer);
                            return concatSource;
                        }, ()=>{});
                    }
                });
            });
        } finally{
            timeEnd('InternalBundleTagPlugin.apply');
        }
    }
    constructor(...args){
        super(...args), this.name = 'bundleTag';
    }
}
export { InternalBundleTagPlugin };
